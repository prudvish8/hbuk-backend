name: Smoke (prod)
on:
  push:
    branches: [ main ]
  workflow_dispatch:
env:
  API: https://hbuk-backend-hvow.onrender.com
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - run: npm run smoke
      - name: Register test user (skip emails)
        env:
          EMAIL: "u${{ github.run_number }}@hbuk.dev"
          PASS: "test123"
        run: |
          curl -sS -X POST "$API/api/register" \
            -H 'Content-Type: application/json' \
            -H 'X-HBUK-SMOKE: 1' \
            -d "{\"email\":\"$EMAIL\",\"password\":\"$PASS\"}" || true

      # âœ… ONLY run this step when a metrics token is configured
      - name: Metrics (token via header; query fallback)
        if: ${{ secrets.HBUK_METRICS_TOKEN != '' }}
        env:
          API: https://hbuk-backend-hvow.onrender.com
          METRICS_TOKEN: ${{ secrets.HBUK_METRICS_TOKEN }}
        run: |
          # header auth
          curl -fsS -H "X-Metrics-Token: $METRICS_TOKEN" "$API/metrics" >/dev/null
          # query fallback (should also 200)
          curl -fsS "$API/metrics?token=$METRICS_TOKEN" >/dev/null

      # Optional: make it explicit when there's no token
      - name: Metrics (skipped: no token configured)
        if: ${{ secrets.HBUK_METRICS_TOKEN == '' }}
        run: echo "Skipping metrics check (no HBUK_METRICS_TOKEN set in repo secrets)."
