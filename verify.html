<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>HBUK Verify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>window.API_BASE='https://hbuk-backend-hvow.onrender.com';</script>
  <style>
    body{font-family:system-ui, sans-serif;max-width:640px;margin:40px auto;padding:0 16px}
    label,input,button,textarea{font-size:16px}
    .row{margin:12px 0}
    .ok{color:green}.bad{color:#b00020}
  </style>
</head>
<body>
  <h1>Verify Entry</h1>
  <div class="row"><label>Entry ID</label><br/><input id="entryId" placeholder="64f..."/></div>
  <div class="row"><label>Digest</label><br/><input id="digest" placeholder="sha256 hex"/></div>
  <div class="row"><button id="btn">Verify</button></div>
  <pre id="out"></pre>
  
  <div id="proof-section" style="display: none; margin-top: 20px;">
    <h3>Proof of Inclusion</h3>
    <button id="proofBtn">Get Proof</button>
    <pre id="proofOut"></pre>
  </div>

  <script type="module">
    import { apiRequest } from './api-utils.js';
    const id = document.getElementById('entryId');
    const digest = document.getElementById('digest');
    const out = document.getElementById('out');
    
    // Prefill fields from hash parameters
    function prefillFromHash() {
      const hash = location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const idParam = params.get('id') || '';
      const digestParam = params.get('digest') || '';
      
      id.value = idParam;
      digest.value = digestParam;
      
      // Show proof section if we have both id and digest
      if (idParam && digestParam) {
        document.getElementById('proof-section').style.display = 'block';
      }
      
      // Optional sanity checks before calling the API:
      const isHex = (s, n) => new RegExp(`^[a-f0-9]{${n}}$`).test(s);
      if (idParam && !isHex(idParam, 24)) {
        out.innerHTML = '<span class="bad">Warning: Enter a valid 24-char entry ID.</span>';
      }
      if (digestParam && !isHex(digestParam, 64)) {
        out.innerHTML = '<span class="bad">Warning: Enter a valid 64-char digest.</span>';
      }
    }
    
    // Prefill on load
    prefillFromHash();
    
    document.getElementById('btn').onclick = async () => {
      out.textContent = 'Checking...';
      try{
        const res = await apiRequest(`/api/verify/${encodeURIComponent(id.value)}/${encodeURIComponent(digest.value)}`, { method: 'GET' });
        out.innerHTML = res.ok ? '<span class="ok">VALID ✅</span>' : '<span class="bad">TAMPERED ❌</span>';
      }catch(e){
        out.innerHTML = `<span class="bad">${e.message}</span>`;
      }
    };
    
    // Proof functionality
    document.getElementById('proofBtn').onclick = async () => {
      const proofOut = document.getElementById('proofOut');
      proofOut.textContent = 'Getting proof...';
      
      try {
        const res = await apiRequest(`/api/anchors/proof/${encodeURIComponent(id.value)}`, { method: 'GET' });
        proofOut.textContent = JSON.stringify(res, null, 2);
      } catch (e) {
        proofOut.textContent = `Error: ${e.message}`;
      }
    };
  </script>
</body>
</html>
